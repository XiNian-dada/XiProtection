name: CI/CD - Auto Release from POM Version

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œç”¨äºç”Ÿæˆå®Œæ•´çš„commitä¿¡æ¯

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'adopt'
        cache: maven

    - name: Build with Maven
      run: mvn -B compile

    - name: Run Tests
      run: mvn -B test

    - name: Package
      run: mvn -B package -DskipTests

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: XiProtection-Build
        path: target/*.jar
        retention-days: 7

  auto-release:
    name: Auto Release from POM
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'adopt'
        cache: maven

    - name: è·å– POM ç‰ˆæœ¬å·
      id: get_version
      run: |
        VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT

    - name: æ£€æŸ¥ Tag æ˜¯å¦å·²å­˜åœ¨
      id: check_tag
      run: |
        if git rev-parse "${{ steps.get_version.outputs.tag_name }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: åˆ›å»º Tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a "${{ steps.get_version.outputs.tag_name }}" -m "Release ${{ steps.get_version.outputs.tag_name }}"
        git push origin "${{ steps.get_version.outputs.tag_name }}"

    - name: ç­‰å¾… Tag åŒæ­¥åˆ° GitHub API
      if: steps.check_tag.outputs.exists == 'false'
      run: sleep 5

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      if: steps.check_tag.outputs.exists == 'false'
      uses: actions/download-artifact@v4
      with:
        name: XiProtection-Build
        path: target

    - name: ç”Ÿæˆ Release Notes
      id: generate_release_notes
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        # 1. ç¡®å®šå½“å‰ Tag å’Œç‰ˆæœ¬
        VERSION="${{ steps.get_version.outputs.version }}"
        TAG_NAME="${{ steps.get_version.outputs.tag_name }}"
        
        echo "å½“å‰ç‰ˆæœ¬: $TAG_NAME"
        
        # 2. æ ¸å¿ƒä¿®æ­£ï¼šåˆ©ç”¨ Git æ‹“æ‰‘å¯»æ‰¾ä¸Šä¸€ä¸ª Tag
        # é€»è¾‘ï¼šä»å½“å‰ HEAD çš„å‰ä¸€ä¸ª commit (HEAD^) å¼€å§‹ï¼Œå¯»æ‰¾æœ€è¿‘çš„ä¸€ä¸ª tag
        # å¦‚æœæ‰¾ä¸åˆ°ï¼ˆæ¯”å¦‚è¿™æ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼‰ï¼Œåˆ™ PREVIOUS_TAG ä¸ºç©º
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || true)
        
        echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: ${PREVIOUS_TAG:-'æ—  (è¿™æ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬)'}"
        
        # 3. è·å–æäº¤æ—¥å¿—
        COMMITS=""
        if [[ -n "$PREVIOUS_TAG" ]]; then
          # è·å–ä¸¤ä¸ª Tag ä¹‹é—´çš„å·®å¼‚
          echo "ç”ŸæˆèŒƒå›´: $PREVIOUS_TAG...$TAG_NAME"
          COMMITS=$(git log "$PREVIOUS_TAG..HEAD" --pretty=format:"%h|%s|%an|%ad" --date=short)
        else
          # å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ª Tagï¼Œè·å–æ‰€æœ‰å†å²
          echo "ç”ŸæˆèŒƒå›´: å…¨éƒ¨æäº¤"
          COMMITS=$(git log --pretty=format:"%h|%s|%an|%ad" --date=short)
        fi

        # ç»Ÿè®¡æäº¤æ•°é‡
        COMMIT_COUNT=0
        if [[ -n "$COMMITS" ]]; then
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
        fi
        
        # ç”Ÿæˆ Release Notes å¤´éƒ¨
        RELEASE_NOTES="## ğŸš€ XiProtection $VERSION\n\n"
        RELEASE_NOTES+="**å‘å¸ƒæ—¶é—´**: $(date '+%Yå¹´%mæœˆ%dæ—¥')\n\n"
        
        if [[ -n "$PREVIOUS_TAG" ]]; then
          RELEASE_NOTES+="**å˜æ›´èŒƒå›´**: $PREVIOUS_TAG â†’ $TAG_NAME\n\n"
        else
          RELEASE_NOTES+="**å˜æ›´èŒƒå›´**: åˆå§‹ç‰ˆæœ¬\n\n"
        fi
        
        RELEASE_NOTES+="### ğŸ“Š å˜æ›´ç»Ÿè®¡\n\n"
        RELEASE_NOTES+="- **æäº¤æ•°é‡**: $COMMIT_COUNT æ¬¡\n"
        # ä¿®å¤äº†è¿™é‡Œçš„å„ç§ç®¡é“å‘½ä»¤å¯¼è‡´å¯èƒ½çš„ç©ºå€¼æŠ¥é”™
        if [[ -n "$COMMITS" ]]; then
            AUTHOR_COUNT=$(echo "$COMMITS" | cut -d'|' -f3 | sort -u | wc -l | tr -d ' ')
        else
            AUTHOR_COUNT=0
        fi
        RELEASE_NOTES+="- **æäº¤è€…**: $AUTHOR_COUNT äºº\n\n"
        
        RELEASE_NOTES+="### ğŸ“ å˜æ›´å†…å®¹\n\n"
        
        if [[ -z "$COMMITS" ]]; then
          RELEASE_NOTES+"> â„¹ï¸ è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥æ²¡æœ‰å˜æ›´\n\n"
        else
          # æŒ‰æäº¤ç±»å‹åˆ†ç±» (é€»è¾‘ä¿æŒä¸å˜)
          FEATURE_COMMITS=$(echo "$COMMITS" | grep -iE "^(feat|feature|add|æ–°å¢|æ·»åŠ )" || true)
          FIX_COMMITS=$(echo "$COMMITS" | grep -iE "^(fix|bug|ä¿®å¤|ä¿®æ­£)" || true)
          DOCS_COMMITS=$(echo "$COMMITS" | grep -iE "^(docs|doc|æ–‡æ¡£|readme)" || true)
          REFACTOR_COMMITS=$(echo "$COMMITS" | grep -iE "^(refactor|refact|é‡æ„|ä¼˜åŒ–)" || true)
          # æ’é™¤ä¸Šè¿°æ‰€æœ‰å…³é”®è¯
          OTHER_COMMITS=$(echo "$COMMITS" | grep -vE "^(feat|feature|add|fix|bug|docs|doc|refactor|refact|æ–°å¢|æ·»åŠ |ä¿®å¤|ä¿®æ­£|æ–‡æ¡£|readme|é‡æ„|ä¼˜åŒ–)" || true)
          
          # è¾…åŠ©å‡½æ•°ï¼šè¾“å‡ºåˆ—è¡¨
          function print_commits() {
              while IFS='|' read -r hash message author date; do
                # ç§»é™¤å¯èƒ½å­˜åœ¨çš„å¼•å·ï¼Œé˜²æ­¢ç ´å Markdown
                clean_msg=$(echo "$message" | sed 's/"//g')
                echo "- $clean_msg"
              done <<< "$1"
          }
          
          if [[ -n "$FEATURE_COMMITS" ]]; then
            RELEASE_NOTES+="#### âœ¨ æ–°åŠŸèƒ½\n\n"
            # æ•è·å‡½æ•°è¾“å‡ºå¹¶è¿½åŠ 
            OUTPUT=$(print_commits "$FEATURE_COMMITS")
            RELEASE_NOTES+="$OUTPUT\n\n"
          fi
          
          if [[ -n "$FIX_COMMITS" ]]; then
            RELEASE_NOTES+="#### ğŸ› é—®é¢˜ä¿®å¤\n\n"
            OUTPUT=$(print_commits "$FIX_COMMITS")
            RELEASE_NOTES+="$OUTPUT\n\n"
          fi
          
          if [[ -n "$DOCS_COMMITS" ]]; then
            RELEASE_NOTES+="#### ğŸ“š æ–‡æ¡£æ›´æ–°\n\n"
            OUTPUT=$(print_commits "$DOCS_COMMITS")
            RELEASE_NOTES+="$OUTPUT\n\n"
          fi
          
          if [[ -n "$REFACTOR_COMMITS" ]]; then
            RELEASE_NOTES+="#### âš¡ ä»£ç ä¼˜åŒ–\n\n"
            OUTPUT=$(print_commits "$REFACTOR_COMMITS")
            RELEASE_NOTES+="$OUTPUT\n\n"
          fi
          
          if [[ -n "$OTHER_COMMITS" ]]; then
            RELEASE_NOTES+="#### ğŸ”§ å…¶ä»–å˜æ›´\n\n"
            OUTPUT=$(print_commits "$OTHER_COMMITS")
            RELEASE_NOTES+="$OUTPUT\n\n"
          fi
        fi
        
        RELEASE_NOTES+="---\n\n"
        RELEASE_NOTES+="### ğŸ“¥ ä¸‹è½½åœ°å€\n\n"
        RELEASE_NOTES+="| æ–‡ä»¶å | ä¸‹è½½é“¾æ¥ |\n"
        RELEASE_NOTES+="|--------|----------|\n"
        RELEASE_NOTES+="| XiProtection-${VERSION}.jar | [ä¸‹è½½](https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/XiProtection-${VERSION}.jar) |\n\n"
        
        RELEASE_NOTES+="### ğŸ”— ç›¸å…³é“¾æ¥\n\n"
        RELEASE_NOTES+="- [å®Œæ•´æäº¤å†å²](https://github.com/${{ github.repository }}/commits/${TAG_NAME})\n"
        if [[ -n "$PREVIOUS_TAG" ]]; then
          RELEASE_NOTES+="- [ä¸ä¸Šä¸ªç‰ˆæœ¬çš„å·®å¼‚](https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${TAG_NAME})\n"
        fi
        RELEASE_NOTES+="- [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)\n\n"
        
        RELEASE_NOTES+="---\n\n"
        RELEASE_NOTES+="<details>\n"
        RELEASE_NOTES+="<summary>ğŸ“‹ è¯¦ç»†æäº¤åˆ—è¡¨</summary>\n\n"
        if [[ -n "$COMMITS" ]]; then
          while IFS='|' read -r hash message author date; do
            clean_msg=$(echo "$message" | sed 's/"//g')
            RELEASE_NOTES+="- **$hash** - $clean_msg\n"
            RELEASE_NOTES+="  - ä½œè€…: $author\n"
            RELEASE_NOTES+="  - æ—¥æœŸ: $date\n\n"
          done <<< "$COMMITS"
        fi
        RELEASE_NOTES+="</details>\n"
        
        # 1. ç”Ÿæˆéšæœºå®šç•Œç¬¦ï¼ˆé˜²æ­¢å†…å®¹ä¸­åŒ…å«EOFå¯¼è‡´æˆªæ–­ï¼‰
        delimiter="$(openssl rand -hex 8)"
        
        # 2. å†™å…¥ GITHUB_OUTPUT
        echo "release_notes<<$delimiter" >> "$GITHUB_OUTPUT"
        
        # 3. å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ echo -e å¼ºåˆ¶è§£æ \n ä¸ºæ¢è¡Œ
        echo -e "$RELEASE_NOTES" >> "$GITHUB_OUTPUT"
        
        echo "$delimiter" >> "$GITHUB_OUTPUT"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"

    - name: è·å– JAR æ–‡ä»¶å
      if: steps.check_tag.outputs.exists == 'false'
      id: get_jar_name
      run: |
        JAR_FILE=$(ls target/*.jar | grep -v original | head -1)
        echo "jar_file=${JAR_FILE}" >> $GITHUB_OUTPUT
        echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

    - name: åˆ›å»º Release
      if: steps.check_tag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v2
      with:
        name: XiProtection ${{ steps.get_version.outputs.version }}
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        body: ${{ steps.generate_release_notes.outputs.release_notes }}
        files: ${{ steps.get_jar_name.outputs.jar_file }}
        draft: false
        prerelease: false

  quality-check:
    name: Quality Check
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'adopt'
        cache: maven

    - name: Run Maven Verify
      run: mvn -B verify -DskipTests

    - name: Check Code Style
      run: mvn -B checkstyle:check

    - name: Check for Vulnerabilities
      run: mvn -B org.owasp:dependency-check-maven:check
      continue-on-error: true  # æ¼æ´æ£€æŸ¥ç»“æœä¸å½±å“æ„å»º